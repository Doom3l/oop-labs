@page
@using Simulator
@model SimulationModel

@section Styles {
    <link rel="stylesheet" href="~/css/simulation.css" />
}

<div class="simulation-container">

    <aside class="hp-panel">
        <h3 style="text-align:center;">❤️ Health</h3>

        @foreach (var entry in Model.CurrentTurn.Health)
        {
            var maxHp = 3;
            var percent = (entry.Value * 100) / maxHp;

            <div style="
                background: white;
                border-radius: 12px;
                padding: 10px;
                margin-bottom: 12px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            ">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    font-weight: bold;
                    margin-bottom: 6px;
                ">
                    <span>@entry.Key</span>
                    <span style="color:#666;">@entry.Value / @maxHp</span>
                </div>

                <div style="
                    width: 100%;
                    height: 14px;
                    background: #ddd;
                    border-radius: 7px;
                    overflow: hidden;
                ">
                    <div style="
                        width: @percent%;
                        height: 100%;
                        border-radius: 7px;
                        transition: width 0.3s ease;
                        background: @(entry.Value == 3 ? "#4caf50" : entry.Value == 2 ? "#ffeb3b" : "#f44336");
                    ">
                    </div>
                </div>
            </div>
        }

        <h3 style="text-align:center; margin-top: 20px;">🗒️ Historia tur</h3>

        <div style="
            font-size: 0.9em;
            padding-right: 4px;
        ">

            @{
                var start = 0;
            }

            @for (int i = start; i <= Model.TurnIndex; i++)
            {
                var t = Model.Log.TurnLogs[i];

                <div style="
                    background: white;
                    border-radius: 8px;
                    padding: 6px;
                    margin-bottom: 6px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
                ">
                    <div>
                        <strong>@i.</strong> @t.Mappable → @t.Move
                    </div>

                    @if (!string.IsNullOrEmpty(t.Message))
                    {
                        <div style="color: red; font-weight: bold;">
                            ⚠️ @t.Message
                        </div>
                    }
                </div>
            }
        </div>
    </aside>

    <!-- MAPA + STEROWANIE -->
    <section class="simulation-main">

        <div class="map-header">
            <form method="post" asp-page-handler="Previous">
                <button>&larr;</button>
            </form>

            <div class="turn">
                Tura @Model.TurnIndex
            </div>

            <form method="post" asp-page-handler="Next">
                <button>&rarr;</button>
            </form>
        </div>

        <div class="map">

        @{
            bool highlighted = false;
        }

        @for (int y = Model.Log.SizeY - 1; y >= 0; y--)
        {
            <p>@y</p>
            @for (int x = 0; x < Model.Log.SizeX; x++)
            {
                var point = new Point(x, y);
                if (Model.CurrentTurn.Symbols.TryGetValue(point, out var symbol))
                {
                var isActive =
                    !highlighted &&
                    symbol != '#' &&
                    (
                        (symbol == 'E' && Model.CurrentTurn.Mappable.StartsWith("ELF")) ||
                        (symbol == 'O' && Model.CurrentTurn.Mappable.StartsWith("ORC")) ||
                        (symbol == 'A' && Model.CurrentTurn.Mappable.StartsWith("ANIMALS")) ||
                        (symbol == 'B' && Model.CurrentTurn.Mappable.Contains("Eagles")) ||
                        (symbol == 'b' && Model.CurrentTurn.Mappable.Contains("Ostriches"))
                    );


                    if (isActive)
                    {
                        highlighted = true;
                    }

                    <div style="@(isActive ? "border: 3px solid gold; box-shadow: 0 0 12px gold; border-radius: 10px;" : "")">
                        <img src="~/images/@(symbol switch {
                            'E' => "elf-80.png",
                            'O' => "ork-80.png",
                            'A' => "rabbit-80.png",
                            'B' => "eagle-80.png",
                            'b' => "emu-80.png",
                            'X' => "combo-80.png",
                            '#' => "rock-80.png",
                            _ => ""
                        })" />
                    </div>
                }
                else
                {
                    <div></div>
                }
            }
        }
        <span></span>
        @for (int x = 0; x < Model.Log.SizeX; x++)
        {
            <span>@x</span>
        }
        </div>

        <div class="map-header">
            @Model.CurrentTurn.Mappable
            <span class="alert">
                &nbsp;&rArr; @Model.CurrentTurn.Move
            </span>

            @if (!string.IsNullOrEmpty(Model.CurrentTurn.Message))
            {
                <div style="color: red; font-weight: bold;">
                    ⚠️ @Model.CurrentTurn.Message
                </div>
            }
        </div>

    </section>
</div>
